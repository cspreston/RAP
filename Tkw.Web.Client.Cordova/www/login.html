<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
 <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Ready Action Plan - User Login</title>

    <meta name="description" content="">
    <meta name="author" content="">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- BEGIN CORE CSS -->
    <link rel="stylesheet" href="Content/pleasure/css/style.css">
    <link rel="stylesheet" href="Content/pleasure/css/elements.css">
    <!-- END CORE CSS -->
    <!-- BEGIN PLUGINS CSS -->
    <link rel="stylesheet" href="Content/pleasure/css/social.css">
    <!-- END PLUGINS CSS -->
    <!-- FIX PLUGINS -->
    <link rel="stylesheet" href="Content/pleasure/css/plugins.css">
    <!-- END FIX PLUGINS -->
    <!-- BEGIN SHORTCUT AND TOUCH ICONS -->
    <link rel="shortcut icon" href="Content/pleasure/images/favicon.ico">
    <link rel="apple-touch-icon" href="Content/pleasure/images/apple-touch-icon.png">
    <!-- END SHORTCUT AND TOUCH ICONS -->
    <!--Kendo styles-->
    <link rel="stylesheet" href="Content/kendo/kendo.common.min.css">
    <link rel="stylesheet" href="Content/kendo/kendo.default.min.css" />
    <link rel="stylesheet" href="Content/kendo/kendo.common-material.min.css">
    <link rel="stylesheet" href="Content/kendo/kendo.rtl.min.css">
    <link rel="stylesheet" href="Content/kendo/kendo.dataviz.min.css">
    <link rel="stylesheet" href="Content/kendo/kendo.dataviz.default.min.css">
    <link rel="stylesheet" href="Content/kendo/kendo.material.mobile.min.css">
    <link rel="stylesheet" href="Content/kendo/kendo.material.min.css">

    <script src="Scripts/jquery-2.1.1.js"></script>
    <script src="Scripts/jquery-2.1.1.min.js"></script>
    <script src="Content/pleasure/js/global-vendors.js"></script>
    <script src="Content/pleasure/js/user-pages.js"></script>
    <script src="Content/pleasure/js/pleasure.js"></script>
    <script src="Content/pleasure/js/layout.js"></script>
    <script src="Content/pleasure/js/modernizr.min.js"></script>
    <script src="scripts/less/less-1.5.1.js" type="text/javascript"></script>

    <script src="Content/kendo/kendo.all.min.js"></script>

    <script src="Scripts/TKWApp/config/configuration.js"></script>
    <script src="Scripts/TKWApp/hard-routing/application-routes.js"></script>
    <script src="Scripts/TKWApp/data/data-store.js"></script>
    <script src="Scripts/TKWApp/data/authentication.js"></script>

</head>
<body class="bg-login printable">
    <div id="loadDiv" class="loading-bar indeterminate margin-top-10"></div>
    <div id="loginscreendiv" class="login-screen" tabindex="1">
        <div class="panel-login blur-content">
            <div class="panel-heading panel-heading-login"><img src="Content/pleasure/images/logo.png" height="100" alt=""></div><!--.panel-heading-->
            <div id="pane-login" class="panel-body panel-body-login active">
                <h2>Login to Dashboard</h2>
                <div class="form-group">
                    <div class="inputer">
                        <div class="input-wrapper">
                            <input type="email" id="tbLoginUsername" class="form-control" placeholder="Enter your user name">

                        </div>
                    </div>
                </div><!--.form-group-->
                <div class="form-group">
                    <div class="inputer">
                        <div class="input-wrapper">
                            <input type="password" id="tbLoginPassword" class="form-control" placeholder="Enter your password">
                        </div>
                    </div>
                </div><!--.form-group-->
                <form action="dashboard" method="get">
                    <div class="form-buttons clearfix">
                        <label class="pull-left"><input type="checkbox" id="tbLoginRememberMe" name="remember" value="1"> Remember me</label>
                        <button type="button" class="btn btn-success pull-right" onclick="doLogin();">Login</button>
                    </div><!--.form-buttons-->
                </form>
                <ul class="extra-links">
                    <li><a href="#" class="show-pane-forgot-password">Forgot your password</a></li>
                </ul>
            </div><!--#login.panel-body-->

            <div id="pane-forgot-password" class="panel-body">
                <h2>Forgot Your Password</h2>
                <div class="form-group">
                    <div class="inputer">
                        <div class="input-wrapper">
                            <input type="email" id="resetPass" class="form-control" placeholder="Enter your email address">
                        </div>
                    </div>
                </div><!--.form-group-->
                <div class="form-buttons clearfix">
                    <button type="submit" class="btn btn-white pull-left show-pane-login">Cancel</button>
                    <button type="submit" class="btn btn-success pull-right" onclick="doReset();">Send</button>
                </div><!--.form-buttons-->
            </div><!--#pane-forgot-password.panel-body-->

            <div id="pane-create-account" class="panel-body">
                <h2>Create a New Account</h2>
                <div class="form-group">
                    <div class="inputer">
                        <div class="input-wrapper">
                            <input type="text" class="form-control" placeholder="Enter your full name">
                        </div>
                    </div>
                </div><!--.form-group-->
                <div class="form-group">
                    <div class="inputer">
                        <div class="input-wrapper">
                            <input type="email" class="form-control" placeholder="Enter your email address">
                        </div>
                    </div>
                </div><!--.form-group-->
                <div class="form-group">
                    <div class="inputer">
                        <div class="input-wrapper">
                            <input type="password" class="form-control" placeholder="Enter your password">
                        </div>
                    </div>
                </div><!--.form-group-->
                <div class="form-group">
                    <div class="inputer">
                        <div class="input-wrapper">
                            <input type="password" class="form-control" placeholder="Enter your password again">
                        </div>
                    </div>
                </div><!--.form-group-->
                <div class="form-group">
                    <label><input type="checkbox" name="remember" value="1"> I have read and agree to the term of use.</label>
                </div>
                <div class="form-buttons clearfix">
                    <button type="submit" class="btn btn-white pull-left show-pane-login">Cancel</button>
                    <button type="submit" class="btn btn-success pull-right">Sign Up</button>
                </div><!--.form-buttons-->
            </div><!--#login.panel-body-->

        </div><!--.blur-content-->
    </div><!--.login-screen-->

    <div class="modal scale fade" id="login-error-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Error</h4>
                </div>
                <div class="modal-body" id="login-error-modal-body">
                    The user could not be authenticated on RAP.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-flat btn-primary" data-dismiss="modal">Ok</button>
                </div>
            </div><!--.modal-content-->
        </div><!--.modal-dialog-->
    </div><!--.modal-->

    <div class="modal scale fade" id="error-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Error</h4>
                </div>
                <div id="error-body" class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-flat btn-default" data-dismiss="modal">Ok</button>
                </div>
            </div><!--.modal-content-->
        </div><!--.modal-dialog-->
    </div>

    <div class="bg-blur dark">
        <div class="overlay"></div><!--.overlay-->
    </div><!--.bg-blur-->

    <svg version="1.1" xmlns='http://www.w3.org/2000/svg'>
        <filter id='blur'>
            <feGaussianBlur stdDeviation='7' />
        </filter>
    </svg>

    <div class="modal scale fade" id="login-root-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">
                        Selected company profile is:
                        <b><span id="selectedTenant"></span> </b>
                    </h4>
                </div>
                <div class="modal-body">
                    <input id="dropdownlist" style="width: 80%" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success pull-right" data-dismiss="modal" onclick="doRootLogin();">Ok</button>
                </div>
            </div><!--.modal-content-->
        </div><!--.modal-dialog-->
    </div>

    <!-- BEGIN GLOBAL AND THEME VENDORS-->
    <!-- END GLOBAL AND THEME VENDORS -->
    <!-- BEGIN PLUGINS AREA -->
    <!--<script src="Content/pleasure/js/global-vendors.js"></script>-->
    <!-- END PLUGINS AREA -->
    <!-- PLUGINS INITIALIZATION AND SETTINGS -->
    <!--<script src="Content/pleasure/js/user-pages.js"></script>-->
    <!-- END PLUGINS INITIALIZATION AND SETTINGS -->
    <!-- PLEASURE Initializer -->
    <!--<script src="Content/pleasure/js/pleasure.js"></script>-->
    <!-- ADMIN 1 Layout Functions -->
    <!--<script src="Content/pleasure/js/layout.js"></script>-->
    <!-- BEGIN INITIALIZATION-->
    <script>
        $(document).ready(function () {
            Pleasure.init();
            Layout.init();
            UserPages.login();
            $("#loadDiv").hide();
        });

        function doLogin() {
            $("#loadDiv").show();
            debugger
            // log off any existing user
            TKWApp.Data.AuthenticationManager.logOff();

            var username = $("#tbLoginUsername").val();
            var password = $("#tbLoginPassword").val();

            // try to login the user with username and password
            TKWApp.Data.AuthenticationManager.authenticate(username, password, function (token) {
                // user authenticated - redirect to dasboard
                if (TKWApp.Data.AuthenticationManager.isAuthenticated()) {
                    if (token.UserType === "Root") {
                        window.location.href = "/Root/index";
                        $("#dropdownlist").kendoDropDownList({
                            dataTextField: "Name",
                            optionLabel: "Change company...",
                            dataValueField: "Id",
                            autoBind: true,
                            cache: false,
                            dataSource: {
                                serverFiltering: true,
                                transport: {
                                    read: {
                                        url: TKWApp.Configuration.ConfigurationManager.ServerUri + "/api/niv/Tenant/GetAll",
                                        beforeSend: function (req) {
                                            req.setRequestHeader('Authorization', "Bearer " + TKWApp.Data.AuthenticationManager.AuthenticationToken.Token);
                                        },
                                        dataType: "json"
                                    }
                                }
                            }
                        });
                        $("#selectedTenant").html(TKWApp.Data.AuthenticationManager.AuthenticationToken.Tenant);
                        //$("#login-root-modal").modal();
                    }
                    else {
                        TKWApp.HardRouting.ApplicationRoutes.redirect("Dashboard");
                    }
                }
                else
                    TKWApp.HardRouting.ApplicationRoutes.redirect("Login");
            }, function (error) {
                $("#loadDiv").hide();
                if (error && error.responseJSON && error.responseJSON.error_description) {
                    $("#login-error-modal-body").html(error.responseJSON.error_description);
                }
                $("#login-error-modal").modal();
            });
        }

        function doReset() {
            $("#loadDiv").show();
            // log off any existing user
            TKWApp.Data.AuthenticationManager.logOff();

            var username = $("#resetPass").val();

            // try to login the user with username and password
            TKWApp.Data.AuthenticationManager.resetPasswordRequest(username,
            function (success) {
                $("#loadDiv").hide();                
                if (success.success) {
                    var info = "An email was sent to your email address. Please check your inbox and follow the instructions!";
                    $("#error-body").html(info);
                    $("#error-modal").modal("show");
                    $("#resetPass").val('');
                }
                else if (!success.success) {
                    var info = "An error has occurred. Please call RAP administrator!";
                    if (success.message) {
                        info = success.message;
                    }
                    $("#error-body").html(info);
                    $("#error-modal").modal("show");
                }
                else {
                    $("#error-body").html("An error has occurred. Please call RAP administrator!");
                    $("#error-modal").modal("show");
                }
            }
            , function (error) {
                $("#loadDiv").hide();
                $("#error-body").html("An error has occurred. Please call RAP administrator!");
                $("#error-modal").modal("show");
            });
        }

        function doRootLogin() {
            // log off any existing user
            var dropdownlist = $("#dropdownlist").data("kendoDropDownList");
            if (dropdownlist && dropdownlist.value().length>0) {
                if (TKWApp.Data.AuthenticationManager.AuthenticationToken.Tenant != dropdownlist.text()) {
                    $.ajax({
                        url: TKWApp.Configuration.ConfigurationManager.ServerUri + "/api/niv/User/SetTenant?id=" + dropdownlist.value(),
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        headers: {
                            "Authorization":"Bearer " + TKWApp.Data.AuthenticationManager.AuthenticationToken.Token,
                        },
                        success: function (data) {
                            var username = $("#tbLoginUsername").val();
                            var password = $("#tbLoginPassword").val();
                            TKWApp.Data.AuthenticationManager.authenticateRoot(username, password, function (token) {
                                if (TKWApp.Data.AuthenticationManager.isAuthenticated()) {
                                    TKWApp.HardRouting.ApplicationRoutes.redirect("Dashboard");
                                }
                                else
                                    TKWApp.HardRouting.ApplicationRoutes.redirect("Login");
                            }, function (error) {
                                $("#login-error-modal").modal();
                            });
                        },
                        error: function () {
                            $("#login-error-modal").modal();
                        }
                    });
                }
            }
            else {
                TKWApp.HardRouting.ApplicationRoutes.redirect("Dashboard");
            }
        }
        $('#loginscreendiv').bind('keydown', function (event) {

            // 13 is the code for ENTER
            switch (event.keyCode) {
                case 13:
                    doLogin();
            }
        });
    </script>
    <!-- END INITIALIZATION-->

</body>
</html>
